# Git マージやコンフリクトについてのメモ

mergeしようとしてコンフリクトが起こると、リポジトリは以下の状態となります。

* コンフリクトが発生しているファイルが印付けされる。
* `MERGE_HEAD`に、マージ元のブランチ（共通の祖先からマージ元ブランチ側に辿ったコミット群）が一時的に記録される。マージ後に消えるWork情報。

コンフリクトを解消する流れは、以下のとおりです。

* コンフリクトを解消して、git addすると、そのファイルに付与されたコンフリクトの印付けが解消される。
* コミットすると、コンフリクト解消のための修正を加味した状態で、マージ元のコミット群がコミット先にマージされる（マージコミットができる）。
* `MERGE_HEAD`が削除される（たぶん）。

`MERGE_HEAD exits.`のエラーは、マージでコンフリクトが起きた時に、コンフリクトを解消して最後までマージをやりきっていない場合に発生するということです。

コンフリクトを解消して最後までマージをやりきるか、マージをキャンセルすることで、このエラーを解消できます。

## マージをキャンセルする方法

### コンフリクト発生直後（コンフリクトを解消すべくファイルを編集して`git add`する前）にマージをキャンセルする場合

`git merge --abort`か`git reset --merge`を利用します。両者はほぼ同じです。`MERGE_HEAD`を削除し、作業ツリーをHEADの状態に戻します。実はスタッシュまわりで違いがあるのですが、意識する必要はあまりないです。詳細については[git mergeのリファレンス](https://git-scm.com/docs/git-merge)の`--abort`のセクションを参照ください。

### コンフリクトを解消すべくファイルを編集し`git add`した後（インデックスに変更を載せたあと）で、マージを取りやめたい場合

この場合も、`git merge --abort`か`git reset --merge`を利用します。`MERGE_HEAD`を削除し、インデックスと作業ツリーの状態を、`HEAD`の状態に戻します。

### コンフリクトを解消すべくファイルを編集してマージコミットまで済ませた後で、マージを無かったことにしたい場合

`git reset --hard ORIG_HEAD`を利用します。`ORIG_HEAD`は`HEAD`の１つ前のコミットのことです。`HEAD`の１つ前のコミットの状態に、リポジトリ／インデックス／作業ツリーを戻します。厳密な説明をすると、リポジトリについては、`HEAD`が指すブランチの参照先が、1つ前のコミットに変更されます。

## マージをやりきるにあたってのTIPS

コンフリクトを解消しようとして色々と編集したが、もともとどんな状態でコンフリクトしたかわからなくなったら、コンフリクトマーカーが埋め込まれた状態に戻ることもできます。

`git checkout --conflict=merge [対象ファイルのパス]`

## 参考資料

`MERGE_HEAD`の説明

https://git-scm.com/docs/gitrevisions

コンフリクトを解消する際に意識する、ベース（共通の祖先） / `HEAD`（マージ先のブランチ） / `MERGE_HEAD`（マージ元のブランチ） についての説明

https://git-scm.com/book/ja/v2/Git-のさまざまなツール-高度なマージ手法

`git reset`の説明

https://git-scm.com/book/ja/v2/Git-のさまざまなツール-リセットコマンド詳説
